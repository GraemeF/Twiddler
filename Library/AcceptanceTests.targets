<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<PropertyGroup>
		<TestFilter Condition=" '$(TestFilter)' == '' ">Category:$(TestCategory)</TestFilter>
		<TestFilter Condition=" '$(TestFilter)' == 'Category:' "></TestFilter>
		<ReportsPath Condition=" '$(ReportsPath)' == '' ">..\Reports\</ReportsPath>
		<RunAcceptanceTests Condition=" '$(RunAcceptanceTests)' == '' ">true</RunAcceptanceTests>
	</PropertyGroup>
	<UsingTask AssemblyFile="Gallio\bin\Gallio.MSBuildTasks.dll"
			   TaskName="Gallio" />

	<Target Name="PrepareForAcceptanceTests">

		<!-- Make sure the Reports folder exists -->
		<MakeDir Directories="$(ReportsPath)" />

	</Target>

	<Target Name="RunAcceptanceTests"
			Inputs="@(MainAssembly)"
			Condition=" '@(AcceptanceTestedAssembly)' != '' "
			DependsOnTargets="CoreBuild; CopyFilesToOutputDirectory; PrepareForAcceptanceTests"
			Outputs="@(MainAssembly->'$(OutDir)%(Filename).$(TestCategory).Acceptance.success.txt');@(MainAssembly->'$(ReportsPath)%(Filename).$(TestCategory).Acceptance.tests.xml')">

		<!-- Add the assembly being built as a test fixture assembly -->
		<CreateItem Include="@(MainAssembly)">
			<Output TaskParameter="Include"
					ItemName="AcceptanceTestFixtureAssembly" />
		</CreateItem>

		<Exec Command='ngen.exe install "@(AcceptanceTestedAssembly)"' ContinueOnError='true' />

		<!-- The test report that was generated by Gallio -->
		<CreateItem Include="@(AcceptanceTestFixtureAssembly->'$(ReportsPath)%(Filename).$(TestCategory).Acceptance.tests.xml')">
			<Output TaskParameter="Include"
					ItemName="AcceptanceTestReport" />
			<Output TaskParameter="Include"
					ItemName="FileWrites" />
		</CreateItem>

		<!-- Run Gallio, recording the exit code as $(AcceptanceTestResult) -->
		<Gallio Files="@(AcceptanceTestFixtureAssembly)"
				ReportDirectory="$(ReportsPath)"
				ReportNameFormat="@(AcceptanceTestFixtureAssembly->'%(Filename).$(TestCategory).Acceptance.tests')"
				Filter="$(TestFilter)"
				ReportTypes="xml">
			<!-- This tells MSBuild to store the output value of the task's ExitCode property
                 into the project's ExitCode property -->
			<Output TaskParameter="ExitCode"
					PropertyName="AcceptanceTestResult"/>
		</Gallio>

		<Message Text="Running acceptance tests in @(AcceptanceTestFixtureAssembly->'%(Filename)') with Gallio returned $(AcceptanceTestResult)." />

		<!-- If acceptance tests succeeded update the timestamp of the file indicating that they passed -->
		<WriteLinesToFile File="@(AcceptanceTestFixtureAssembly->'$(OutDir)%(Filename).$(TestCategory).Acceptance.success.txt')"
						  Lines="Success"
						  Overwrite="true" />

	</Target>

	<Target Name="GenerateAcceptanceTestReports"
			Condition="'$(BuildingInsideVisualStudio)'!='true' and '$(RunAcceptanceTests)'=='true'"
			DependsOnTargets="RunAcceptanceTests; CoreBuild; CopyFilesToOutputDirectory" />

</Project>
